# Model development for Multinomial logsitic regression for treatment duration

    knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
    library(dplyr)
    library(nnet)
    library(ggplot2)
    library(tidyr)
    library(data.table)
    library(gtsummary) #for regression table
    library(webshot) #to save it as image 
    library(gt) #to save it as image 
    library(truncnorm)
    library(car)
    library(tidytable)
    library(lmtest) #likelihood ratio tests
    library(lsr)
    library(broom)
    library(knitr)
    library(kableExtra)
    library(forestplot)
    library(grid)

# Read in Data

    BTD_model_data0 <- fread("../Processed_data/Modeling/episode_model_df_v2.csv") %>%
      mutate(age = ifelse(der_yob==0 | age <0, NA, age),
             pat_region = ifelse(pat_region=="", NA, pat_region))

    ### create outcome variable: treatment_duration_group 
    BTD_model_data <- BTD_model_data0 %>%
      filter(!is.na(sex) & !is.na(age) & !is.na(pay_type) & age!="" & sex !="" & pay_type!="") %>%
      mutate(
        treatment_duration_group = case_when(
          episode.duration >= 1 & episode.duration <= 92 ~ "0-3 months",
          episode.duration > 92 & episode.duration <= 180 ~ "3-6 months",
          episode.duration > 180 & episode.duration <= 365 ~ "6-12 months",
          episode.duration > 365 ~ ">12 months"
        )
      ) %>%
      filter(!is.na(zip3) & !zip3 %in% c("", " ", "000", "???", "702") & pat_region !="") %>%
      mutate(pay_type = ifelse(pay_type %in% c("Medicare Cost", "Medicare Risk"), "Medicare", pay_type)) %>%
      filter(!is.na(age_group) & age_group !="" & episode.start > as.Date("2006-01-01") & episode.start < as.Date("2022-12-31")) %>%
      mutate(across(depression:bupre_tx, ~ ifelse(is.na(.), FALSE, .))) 

## Convert to factors

    ## convert variable of interests to factors and set the reference group 

    BTD_model_data$treatment_duration_group <- factor(BTD_model_data$treatment_duration_group)
    BTD_model_data$SVI_3digit_class <- factor(BTD_model_data$SVI_3digit_class)
    BTD_model_data$group_BP <- factor(BTD_model_data$group_BP)
    BTD_model_data$group_MHAndSU <- factor(BTD_model_data$group_MHAndSU)
    #Check variable names 
    BTD_model_data$sex <- factor(BTD_model_data$sex)
    ###BTD_model_data$age <- factor(BTD_model_data$age) #if age is a categorical; if not, ignore this
    BTD_model_data$pay_type <- factor(BTD_model_data$pay_type) 
    BTD_model_data$pat_region <- factor(BTD_model_data$pat_region) 

    BTD_model_data$treatment_duration_group <- relevel(BTD_model_data$treatment_duration_group, ref = "0-3 months")
    BTD_model_data$SVI_3digit_class <- relevel(BTD_model_data$SVI_3digit_class, ref = "High")
    BTD_model_data$group_BP <- relevel(BTD_model_data$group_BP, ref = "Low-provider density")
    BTD_model_data$group_MHAndSU <- relevel(BTD_model_data$group_MHAndSU, ref = "Low mental health services density")
    BTD_model_data$sex <- relevel(BTD_model_data$sex, ref = "Male") #To put male as reference 
    BTD_model_data$pay_type <- relevel(BTD_model_data$pay_type, ref = "Commercial")
    BTD_model_data$pat_region <- relevel(BTD_model_data$pat_region, ref = "West")

## Further filtering with minumum 12-month enrollment time

    ## read in patient enrollment range 
    range <- readRDS("../Processed_data/patient_enrollment_days.rds")
    id_12mon <- range[range$enrollment_days>=365]$pat_id

    BTD_model_data1 <- BTD_model_data %>%
      filter(pat_id %in% id_12mon)

# Summary table

## No enrollment period limit

    library(table1)

    ### patient level data (retain the first record)
    pat_data <- BTD_model_data %>%
      group_by(pat_id) %>%
      arrange(episode.start) %>%
      slice(1) %>%
      ungroup()

    strata <- c(list("Episode-level" = BTD_model_data), 
                list("Individual-level"= pat_data))

    labels <- list(variables=list(sex = "Sex",
                                  pat_region = "Region of residence",
                                  age_group = "Age group", 
                                  pay_type = "Insurance type", 
                                  SVI_3digit_class = "Social vulnerability index category", 
                                  group_BP = "Buprenorphine treatment density group",
                                  group_MHAndSU = "Mental health and substances services density group",
                                  schizo = "Schizophrenia", 
                                  bipolar = "Bipolar disorder",
                                  anxiety = "Anxiety", ptsd = "Post-traumatic stress disorder",
                                  hiv = "HIV/AIDS diagnosis",
                                  depression = "Depressive disorder", 
                                  outpatient = "Outpatient visits",
                                  psychiatric = "Psychiatric visits", 
                                  telehealth = "Telehealth services",
                                  induction = "Induction and maintenance treatment",
                                  bupre_tx = "Buprenorphine treatment services")#,
                                  
    #groups= list("Episode-level","Individual-level")
    )
    ## summary table for episode and patient level
    table1 <- table1(strata, labels, #groupspan=c(1,1), 
                     big.mark=",") 
    table1



    # table1(~sex + pat_region + age_group + pay_type + SVI_3digit_class+ group_BP + group_MHAndSU + schizo + bipolar + anxiety + ptsd + hiv + depression + outpatient + psychiatric + telehealth + induction + bupre_tx, data = BTD_model_data, )

## 12-month enrollment period limit

    pat_data1 <- BTD_model_data1 %>%
      group_by(pat_id) %>%
      arrange(episode.start) %>%
      slice(1) %>%
      ungroup()

    strata1 <- c(list("Episode-level" = BTD_model_data1), 
                list("Individual-level"= pat_data1))

    ## summary table for episode and patient level
    table2 <- table1(strata, labels, big.mark=",") 
    table2

    library(dplyr)

    # Convert specified columns to factors
    BTD_model_data <- BTD_model_data %>%
      mutate_at(vars(alcohol, nodrug, schizo, bipolar, anxiety, ptsd, hiv, hepc, 
                     depression, outpatient, psychiatric, mat, telehealth, induction, bupre_tx), 
                as.factor) %>% 
      rename(non_opioid_drugs = nodrug)
    # Verify conversion
    str(BTD_model_data)

    # Convert specified columns to factors
    BTD_model_data1 <- BTD_model_data1 %>%
      mutate_at(vars(alcohol, nodrug, schizo, bipolar, anxiety, ptsd, hiv, hepc, 
                     depression, outpatient, psychiatric, mat, telehealth, induction, bupre_tx), 
                as.factor) %>% 
      rename(non_opioid_drugs = nodrug)

# Examine correlation among the covariates

    #install.packages(c("vcd", "polycor", "rcompanion", "ltm"))  

    library(vcd)        # for assocstats() – Cramér's V
    library(polycor)    # for polychoric correlation
    library(psych)      # for biserial.cor
    library(ltm)        # also has biserial.cor()
    library(lsr)       # For eta-squared
    library(car)       # For Anova if needed

    # Determine if variable is ordinal
    is_ordinal <- function(x) {
      is.ordered(x)
    }

    # Cramér's V
    cramers_v <- function(x, y) {
      tbl <- table(x, y)
      if (min(dim(tbl)) == 1) return(NA)
      suppressWarnings(assocstats(tbl)$cramer)
    }

    # Revised: Point-biserial correlation using Pearson
    point_biserial <- function(x, y) {
      if (!is.factor(y) || length(levels(y)) != 2) return(NA)
      # Convert to numeric 0/1
      y_num <- as.numeric(y) - 1
      cor(x, y_num, use = "pairwise.complete.obs")
    }


    # Polyserial
    poly_serial <- function(x, y) {
      tryCatch(polycor::polyserial(x, y), error = function(e) NA)
    }

    # Eta squared (effect size for ANOVA)
    eta_sq <- function(cont, cat) {
      df <- data.frame(cont = cont, cat = cat)
      fit <- tryCatch(aov(cont ~ cat, data = df), error = function(e) return(NA))
      if (inherits(fit, "aov")) {
        tryCatch(etaSquared(fit)[1, "eta.sq"], error = function(e) NA)
      } else {
        return(NA)
      }
    }

    # Mixed correlation matrix
    mixed_corr_matrix <- function(data) {
      vars <- colnames(data)
      n <- length(vars)
      corr_mat <- matrix(NA, n, n, dimnames = list(vars, vars))
      
      for (i in 1:n) {
        for (j in i:n) {
          xi <- data[[i]]
          xj <- data[[j]]
          
          val <- NA
          # Continuous - continuous
          if (is.numeric(xi) && is.numeric(xj)) {
            val <- cor(xi, xj, use = "pairwise.complete.obs")
          }
          # Categorical - categorical
          else if (is.factor(xi) && is.factor(xj)) {
            val <- cramers_v(xi, xj)
          }
          # Continuous - categorical
          else if (is.numeric(xi) && is.factor(xj)) {
            if (length(unique(xj)) == 2) {
              val <- point_biserial(xi, xj)
            } else if (is_ordinal(xj)) {
              val <- poly_serial(xi, xj)
            } else {
              val <- eta_sq(xi, xj)
            }
          }
          # Categorical - continuous (flip)
          else if (is.factor(xi) && is.numeric(xj)) {
            if (length(unique(xi)) == 2) {
              val <- point_biserial(xj, xi)
            } else if (is_ordinal(xi)) {
              val <- poly_serial(xj, xi)
            } else {
              val <- eta_sq(xj, xi)
            }
          }
          
          corr_mat[i, j] <- val
          corr_mat[j, i] <- val
        }
      }
      return(corr_mat)
    }

    # Prepare data
    df <- data
    df[] <- lapply(df, function(x) {
      if (is.character(x)) return(as.factor(x))
      else return(x)
    })

    # Compute matrix
    corr_mat <- mixed_corr_matrix(df)

    colnames(corr_mat) <- c("Region of Residence", "Insurance type","Sex", 
                            "Depressive disorder", "Anxiety", "Outpatient visits", "Psychiatric",
                            "Age (years)*", "SVI (rescaled 0-1)*", "Bup trt provider density*", "MHSU services density*")
    rownames(corr_mat) <-  c("Region of Residence", "Insurance type","Sex", 
                             "Depressive disorder", "Anxiety", "Outpatient visits", "Psychiatric",
                             "Age (years)*", "SVI (rescaled 0-1)*", "Bup trt provider density*", "MHSU services density*")

    # Visualize
    #pdf(file = "../Figures/Correlation_heatmap.pdf")
    ggcorrplot(corr_mat, type = "lower", lab = TRUE)
    #dev.off()

# Model 1 - demographics only

## 1. Fit the model

    # Fit multinomial logistic regression model; check variable names (sex and age)
    model1 <- multinom(treatment_duration_group ~ der_sex + age + pay_type + pat_region, data = BTD_model_data1)

    # save model results 
    saveRDS(model1, "../Results/BupDuration/MNR_model1_with_12mon_limit_v2.rds")

## 2. Interpret the coefficients

We have just the coefficients but we can exponentiate them to obtain the
relative risk (sometimes referred as odds ratio)

    model1 <- readRDS("../Results/BupDuration/MNR_model1_with_12mon_limit_v2.rds")
    results1 <- tidy(model1, conf.int = TRUE, exponentiate = TRUE) 
    results1

## 3. Calculate metrics: AIC

    # Check AIC for model comparison
    AIC(model1) 

## 4. Likelihood ratio tests

The likelihood ratio test is a test of the sufficiency of a smaller
model versus a more complex model. In this case all the variables added
were significant to assess the outcome.

    #Anova(model1) 

## Forest Plot

    # Model results
    forest_model1 <- function (duration) {
    MOD <- results1 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == duration)

    #### create a table with CI in parentheses
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)

    values <- mapply(function(est, l, h) {
      paste0(est, " (", l, ", ", h, ")")
    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, values[2], NA, NA, values[1], NA, NA, values[3:5], NA, NA, values[6:8])

    mean = c(NA, NA,
             confint$estimate[2], NA, NA, confint$estimate[1], NA, NA, confint$estimate[3:5], NA, NA, confint$estimate[6:8])

    lower = c(NA, NA, 
              confint$conf.low[2], NA, NA, confint$conf.low[1], NA, NA, confint$conf.low[3:5], NA, NA, confint$conf.low[6:8])

    upper = c(NA, NA,
             confint$conf.high[2], NA, NA, confint$conf.high[1],  NA, NA, confint$conf.high[3:5], NA, NA, confint$conf.high[6:8])

    variables =  c("Variables", NA,
      "Age at episode", "Sex", "Male (Reference)", "Female",
      "Insurance type", "Commercial (Reference)", "Medicaid", "Medicare", "Self-insured",
      "Region of residence", "West (Reference)", "East", "Midwest", "South"
    )
    tabletext<-cbind(variables, estimates)
    return(list(tabletext, mean, lower, upper))
    }

### Medium vs. short

    model1_results <- forest_model1("3-6 months")  
    tabletext <- model1_results[[1]]
    mean <- model1_results[[2]]
    lower <- model1_results[[3]]
    upper <- model1_results[[4]]

    #png(file="../Figures/forest_medium_model1.png",width=1500,height=800, res =200)
    #pdf(file="../Figuresforest_medium_model1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.1,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F,F,T,F,F,T,F,F,F,F, T,F,F,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.75,2.0, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2.0, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(1, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(8,"cm")
                     )
    )

    #dev.off()

### Extended Medium vs. short

    model1_results <- forest_model1("6-12 months")  
    tabletext <- model1_results[[1]]
    mean <- model1_results[[2]]
    lower <- model1_results[[3]]
    upper <- model1_results[[4]]

    #png(file="../Figures/forest_extMedium_model1.png",width=1500,height=800, res =200)
    #pdf(file="../Figuresforest_medium_model1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.1,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F,F,T,F,F,T,F,F,F,F, T,F,F,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.75,2.0, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2.0, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(1, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(8,"cm")
                     )
    )

    #dev.off()

### Long vs. short

    model1_results <- forest_model1(">12 months")  
    tabletext <- model1_results[[1]]
    mean <- model1_results[[2]]
    lower <- model1_results[[3]]
    upper <- model1_results[[4]]
    #png(file="../Figures/forest_long_model1.png",width=1500,height=800, res =200)
    #pdf(file="../Figuresforest_medium_model1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.1,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F,F,T,F,F,T,F,F,F,F, T,F,F,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.75,2.25, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2.25, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(1, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(8,"cm")
                     )
    )

    #dev.off()

# Model 2 - Demographics + Contextual SDOH

## 1. Fit the model

    # Fit multinomial logistic regression model; check variable names (sex and age)
    model2 <- multinom(treatment_duration_group ~ SVI_3digit_class + group_BP + group_MHAndSU + sex + age + pay_type, data = BTD_model_data1)

    # save model results 
    saveRDS(model2, "../Results/BupDuration/MNR_model2_with_12mon_limit_v2.rds")

## 2. Interpret the coefficients

    model2 <- readRDS("../Results/BupDuration/MNR_model2_with_12mon_limit_v2.rds")
    results2 <- tidy(model2, conf.int = TRUE, exponentiate = TRUE) 
    results2

## 3. Calculate metrics

    # Check AIC for model comparison
    AIC(model2) 

## 4. Likelihood ratio tests

    #Anova(model2) 

## Forest plot

    # Model results
    forest_model2 <- function (duration) {
    MOD <- results2 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == duration)

    #### create a table with CI in parentheses
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)

    values <- mapply(function(est, l, h) {
      paste0(est, " (", l, ", ", h, ")")
    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA,
                  NA, NA, values[1:3], NA, NA, values[4:6], NA, NA, values[7:9], 
                  values[11], NA, NA, values[10], NA, NA, values[12:14])

    mean = c(NA, NA,
             NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[4:6], NA, NA, confint$estimate[7:9],
             confint$estimate[11], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14])

    lower = c(NA, NA, 
              NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[4:6], NA, NA,confint$conf.low[7:9],
              confint$conf.low[11], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14])

    upper = c(NA, NA, 
              NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[4:6], NA, NA,confint$conf.high[7:9],
              confint$conf.high[11], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14])

    variables =  c("Variables", NA,
      "Social Vulnerability Index", "High", "Low", "Low-Medium", "Medium-High",
      "Mental health services density",
        "Low mental health services density",
        "High mental health services density",
        "Moderate-High mental health services density",
        "Moderate-Low mental health services density",
      "Buprenorphine-waivered providers density",
        "Low-provider density",
        "High provider density",
        "Moderate-High provider density",
        "Moderate-Low provider density",
      "Age at episode", "Sex", "Male (Reference)", "Female",
      "Insurance type", "Commercial (Reference)", "Medicaid", "Medicare", "Self-insured"
    )
    tabletext<-cbind(variables, estimates)
    return(list(tabletext, mean, lower, upper))
    }

### Medium duration vs. short duration

    model2_results <- forest_model2("3-6 months")  
    tabletext <- model2_results[[1]]
    mean <- model2_results[[2]]
    lower <- model2_results[[3]]
    upper <- model2_results[[4]]


    #png(file="../Figures/forest_medium_model2.png", width=2000, height=2000, res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.1,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F,F,F), 3), F, T,F,F, T,F,F,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.5,2.25, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.5,2.25, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(1, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(8,"cm")
                     )
    )

    #dev.off()

    include_graphics("../Figures/forest_medium_model2.png")

### Extended medium vs. short

    model2_results <- forest_model2("6-12 months")  
    tabletext <- model2_results[[1]]
    mean <- model2_results[[2]]
    lower <- model2_results[[3]]
    upper <- model2_results[[4]]


    #png(file="../Figures/forest_extMedium_model2.png", width=2000, height=2000, res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F,F,F), 3), F, T,F,F, T,F,F,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.5,2, by=0.5),
                     #xlog=T,
                     grid = structure(seq(0.5,2, by=0.5),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(10, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    #dev.off()

    include_graphics("../Figures/forest_extmedium_model2.png")

### Long vs. short

    model2_results <- forest_model2(">12 months")  
    tabletext <- model2_results[[1]]
    mean <- model2_results[[2]]
    lower <- model2_results[[3]]
    upper <- model2_results[[4]]


    #png(file="../Figures/forest_long_model2.png", width=2000, height=2000, res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F,F,F), 3), F, T,F,F, T,F,F,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.75,2, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                    txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(10, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    #dev.off()

    include_graphics("../Figures/forest_long_model2.png")

# Model 3 - Demographics + Contextual SDOH + diagnostics predictors

## 1. Fit the model

    # Fit multinomial logistic regression model; check variable names (sex and age)
    model3 <- multinom(treatment_duration_group ~ SVI_3digit_class + group_BP + group_MHAndSU + sex + age + pay_type + alcohol + non_opioid_drugs + ptsd + depression + schizo + bipolar + anxiety, data = BTD_model_data1) 

    # save model results 
    saveRDS(model3, "../Results/BupDuration/MNR_model4_with_12mon_limit_v2.rds")

## 2. Interpret the coefficients

We have just the coefficients but we can exponentiate them to obtain the
relative risk (sometimes referred as odds)

    model3 <- readRDS("../Results/BupDuration/MNR_model4_with_12mon_limit_v2.rds")
    results3 <- tidy(model3, conf.int = TRUE, exponentiate = TRUE) 
    results3

## 3. Calculate metrics

    # Check AIC for model comparison
    AIC(model3) 

## 4. Likelihood ratio tests

    #Anova(model3) 

## Forest plot

    # Model results
    forest_model3 <- function (duration) {
    MOD <-results3 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == duration)
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values <- mapply(function(est, l, h) {
      paste0(est, " (", l, ", ", h, ")")
    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA,  confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6]
    )

    variables =  c("Variables", NA,
      "Alcohol use", "No", "Yes",
      "Non-opioid drug use", "No", "Yes",
      "PTSD diagnosis", "No", "Yes",
      "Depression diagnosis", "No", "Yes",
      "Anxiety diagnosis", "No", "Yes",
      "Schizophrenia diagnosis", "No", "Yes",
      "Bipolar disorder diagnosis", "No", "Yes",

      "Sex", "Male", "Female",
      "Insurance type", "Commercial", "Medicaid", "Medicare", "Self-insured",
      "Age at episode",

      "Social Vulnerability Index", "High", "Low", "Low-Medium", "Medium-High",
      "Mental health services density",
        "Low mental health services density",
        "High mental health services density",
        "Moderate-High mental health services density",
        "Moderate-Low mental health services density",
      "Buprenorphine-waivered providers density",
        "Low-provider density",
        "High provider density",
        "Moderate-High provider density",
        "Moderate-Low provider density"
    )

    tabletext<-cbind(variables, estimates)

    return(list(tabletext, mean, lower, upper))
    }

### Medium duration vs. short duration

    model3_results <- forest_model3("3-6 months")  
    tabletext <- model3_results[[1]]
    mean <- model3_results[[2]]
    lower <- model3_results[[3]]
    upper <- model3_results[[4]]

    # total
    #png(file="forest_medium_model3.png",width=2000,height=2000, res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 8), T,F,F,F,F, F, rep(c(T,F,F,F,F),3)),
                     vertices=TRUE, 
                     xticks=seq(0.75,2, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(8,"cm")
                     )
    )

    #dev.off()

    include_graphics("../Figures/forest_medium_model3.png")

### Extended Medium duration vs. short duration

    model3_results <- forest_model3("6-12 months")  
    tabletext <- model3_results[[1]]
    mean <- model3_results[[2]]
    lower <- model3_results[[3]]
    upper <- model3_results[[4]]

    # total
    png(file="forest_extMedium_model3.png",width=2000,height=2000, res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 8), T,F,F,F,F, F, rep(c(T,F,F,F,F),3)),
                     vertices=TRUE, 
                     xticks=seq(0.75,2, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_extmedium_model3.png")

### Long duration vs. short duration

    model3_results <- forest_model3(">12 months")  
    tabletext <- model3_results[[1]]
    mean <- model3_results[[2]]
    lower <- model3_results[[3]]
    upper <- model3_results[[4]]

    # total
    png(file="forest_long_model3.png",width=2000,height=2000, res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 8), T,F,F,F,F, F, rep(c(T,F,F,F,F),3)),
                     vertices=TRUE, 
                     xticks=seq(0.5,2, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.5,2, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_long_model3.png")

# Model 4 - Demographics + Contextual SDOH + diagnostics + health services utilization predictors (final model)

## 1. Fit the model

    model4 <- multinom(treatment_duration_group ~ SVI_3digit_class + group_BP + group_MHAndSU + sex + age + pay_type + alcohol + non_opioid_drugs + ptsd + depression + schizo + bipolar + anxiety + outpatient + psychiatric + mat + telehealth + induction + bupre_tx, data = BTD_model_data1) 
    # save model results 
    saveRDS(model4, "../Results/BupDuration/MNR_model4_with_12mon_limit_v2.rds")

## 2. Interpret the coefficients

    model4 <- readRDS("../Results/BupDuration/MNR_model4_with_12mon_limit_v2.rds")
    results4 <- tidy(model4, conf.int = TRUE, exponentiate = TRUE) 


    results4 %>%
      as.data.frame() %>%
      dplyr::select(y.level,term, estimate, conf.low, conf.high) %>%
      kable(digits=3) %>%
      kable_styling("basic", full_width = FALSE)

## 3. Calculate metrics: AIC

    # Check AIC for model comparison
    AIC(model4) 

## 4. Likelihood ratio tests

    #Anova(model4) 

    ### Step AIC
    ## took too long time to run
    library(MASS)
    #stepAIC(model4, direction = "both")

## Forest plot

### Medium duration vs. short duration

    # Model results
    MOD <-results4 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == "3-6 months")
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values = paste0(estimate, " (", low, ", ", high, ")")
    values <- mapply(function(est, l, h) {

      paste0(est, " (", l, ", ", h, ")")

    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    require(forestplot)
    library(grid)
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[22], NA, NA, values[23], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[25], NA, NA, values[26], NA, NA, values[27], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6], NA, NA, values[24]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[22], NA, NA, confint$estimate[23], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[25], NA, NA, confint$estimate[26], NA, NA, confint$estimate[27], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6], NA, NA, confint$estimate[24]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[22], NA, NA, confint$conf.low[23], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA, confint$conf.low[25], NA, NA, confint$conf.low[26],NA, NA, confint$conf.low[27], NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6], NA, NA, confint$conf.low[24]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[22], NA, NA, confint$conf.high[23], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[25], NA, NA, confint$conf.high[26], NA, NA, confint$conf.high[27], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6], NA, NA, confint$conf.high[24]
    )

    variables =  c("Variables", NA,
      "Alcohol use", "No", "Yes",
      "Non-opioid drug use", "No", "Yes",
      "Outpatient visit", "No", "Yes",
      "Psychiatric visit", "No", "Yes",
      "PTSD diagnosis", "No", "Yes",
      "Depression diagnosis", "No", "Yes",
      "Anxiety diagnosis", "No", "Yes",
      "Schizophrenia diagnosis", "No", "Yes",
      "Bipolar disorder diagnosis", "No", "Yes",
      "Sex", "Male", "Female",
      "Insurance type", "Commercial", "Medicaid", "Medicare", "Self-insured",
      "Age at episode",
      "Telehealth services", "No", "Yes",
      "Induction and maintenance treatment", "No", "Yes",
      "Buprenorphine treatment services", "No", "Yes",
      "Social Vulnerability Index", "High", "Low", "Low-Medium", "Medium-High",
      "Mental health services density",
        "Low mental health services density",
        "High mental health services density",
        "Moderate-High mental health services density",
        "Moderate-Low mental health services density",
      "Buprenorphine-waivered providers density",
        "Low-provider density",
        "High provider density",
        "Moderate-High provider density",
        "Moderate-Low provider density",
      "MAT", "No", "Yes"
    )

    tabletext<-cbind(variables, estimates)    

    # total
    png(file="../Figures/forest_medium_model4.png",width=2000,height=2200,res =200)
    #pdf(file="forest_plot1.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 10), T,F,F,F,F, F, rep(c(T,F,F),3), rep(c(T,F,F,F,F),3), T,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.5,2, by=0.5),
                     #xlog=T,
                     grid = structure(seq(0.5,2, by=0.5),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(10, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_medium_model4.png")

### Extended medium duration vs. short duration

    # Model results
    MOD <-results4 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == "6-12 months")
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values = paste0(estimate, " (", low, ", ", high, ")")
    values <- mapply(function(est, l, h) {

      paste0(est, " (", l, ", ", h, ")")

    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    require(forestplot)
    library(grid)
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[22], NA, NA, values[23], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[25], NA, NA, values[26], NA, NA, values[27], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6], NA, NA, values[24]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[22], NA, NA, confint$estimate[23], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[25], NA, NA, confint$estimate[26], NA, NA, confint$estimate[27], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6], NA, NA, confint$estimate[24]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[22], NA, NA, confint$conf.low[23], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA, confint$conf.low[25], NA, NA, confint$conf.low[26],NA, NA, confint$conf.low[27], NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6], NA, NA, confint$conf.low[24]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[22], NA, NA, confint$conf.high[23], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[25], NA, NA, confint$conf.high[26], NA, NA, confint$conf.high[27], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6], NA, NA, confint$conf.high[24]
    )

    variables =  c("Variables", NA,
      "Alcohol use", "No", "Yes",
      "Non-opioid drug use", "No", "Yes",
      "Outpatient visit", "No", "Yes",
      "Psychiatric visit", "No", "Yes",
      "PTSD diagnosis", "No", "Yes",
      "Depression diagnosis", "No", "Yes",
      "Anxiety diagnosis", "No", "Yes",
      "Schizophrenia diagnosis", "No", "Yes",
      "Bipolar disorder diagnosis", "No", "Yes",
      "Sex", "Male", "Female",
      "Insurance type", "Commercial", "Medicaid", "Medicare", "Self-insured",
      "Age at episode",
      "Telehealth services", "No", "Yes",
      "Induction and maintenance treatment", "No", "Yes",
      "Buprenorphine treatment services", "No", "Yes",
      "Social Vulnerability Index", "High", "Low", "Low-Medium", "Medium-High",
      "Mental health services density",
        "Low mental health services density",
        "High mental health services density",
        "Moderate-High mental health services density",
        "Moderate-Low mental health services density",
      "Buprenorphine-waivered providers density",
        "Low-provider density",
        "High provider density",
        "Moderate-High provider density",
        "Moderate-Low provider density",
      "MAT", "No", "Yes"
    )

    tabletext<-cbind(variables, estimates)    

    # total
    png(file="../Figures/forest_extMedium_model4.png",width=2000,height=2500, res =200)
    #pdf(file="forest_plot2.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F,rep(c(T,F,F), 10), T,F,F,F,F, F,rep(c(T,F,F), 3), T,F,F,F,F,T,F,F,F,F,T,F,F,F,F,T,F,F),
                     vertices=TRUE, 
                     xticks=seq(0.5,2.5, by=0.5),
                     #xlog=T,
                     grid = structure(seq(0.5,2, by=0.5),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_extmedium_model4.png")

### Long duration vs. short duration

    # Model results
    MOD <-results4 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == ">12 months")
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values = paste0(estimate, " (", low, ", ", high, ")")
    values <- mapply(function(est, l, h) {

      paste0(est, " (", l, ", ", h, ")")

    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    require(forestplot)
    library(grid)
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[22], NA, NA, values[23], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[25], NA, NA, values[26], NA, NA, values[27], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6], NA, NA, values[24]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[22], NA, NA, confint$estimate[23], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[25], NA, NA, confint$estimate[26], NA, NA, confint$estimate[27], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6], NA, NA, confint$estimate[24]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[22], NA, NA, confint$conf.low[23], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA, confint$conf.low[25], NA, NA, confint$conf.low[26],NA, NA, confint$conf.low[27], NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6], NA, NA, confint$conf.low[24]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[22], NA, NA, confint$conf.high[23], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[25], NA, NA, confint$conf.high[26], NA, NA, confint$conf.high[27], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6], NA, NA, confint$conf.high[24]
    )

    variables =  c("Variables", NA,
      "Alcohol use", "No", "Yes",
      "Non-opioid drug use", "No", "Yes",
      "Outpatient visit", "No", "Yes",
      "Psychiatric visit", "No", "Yes",
      "PTSD diagnosis", "No", "Yes",
      "Depression diagnosis", "No", "Yes",
      "Anxiety diagnosis", "No", "Yes",
      "Schizophrenia diagnosis", "No", "Yes",
      "Bipolar disorder diagnosis", "No", "Yes",
      "Sex", "Male", "Female",
      "Insurance type", "Commercial", "Medicaid", "Medicare", "Self-insured",
      "Age at episode",
      "Telehealth services", "No", "Yes",
      "Induction and maintenance treatment", "No", "Yes",
      "Buprenorphine treatment services", "No", "Yes",
      "Social Vulnerability Index", "High", "Low", "Low-Medium", "Medium-High",
      "Mental health services density",
        "Low mental health services density",
        "High mental health services density",
        "Moderate-High mental health services density",
        "Moderate-Low mental health services density",
      "Buprenorphine-waivered providers density",
        "Low-provider density",
        "High provider density",
        "Moderate-High provider density",
        "Moderate-Low provider density",
      "MAT", "No", "Yes"
    )

    tabletext<-cbind(variables, estimates)    

    # total
    png(file="../Figures/forest_long_model4.png",width=2000,height=2500, res =200)
    #pdf(file="forest_plot2.pdf", height=14, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F,rep(c(T,F,F), 10), T,F,F,F,F, F,rep(c(T,F,F), 3), T,F,F,F,F,T,F,F,F,F,T,F,F,F,F,T,F,F),
                     vertices=TRUE, 
                     xticks=seq(0,2, by=0.5),
                     #xlog=T,
                     grid = structure(seq(0,2, by=0.5),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_long_model4.png")

# Model 5 Remove mat (based on likelihood ratio tests)

## 1. Fit the model

    model5 <- multinom(treatment_duration_group ~ SVI_3digit_class + group_BP + group_MHAndSU + sex + age + pay_type + alcohol + non_opioid_drugs + ptsd + depression + schizo + bipolar + anxiety + outpatient + psychiatric + telehealth + induction + bupre_tx, data = BTD_model_data1) 

    # save model results 
    saveRDS(model5, "../Results/BupDuration/MNR_model5_with_12mon_limit_v2.rds")

## 2. Interpret the coefficients

    model5 <- readRDS("../Results/BupDuration/MNR_model5_with_12mon_limit_v2.rds")
    results5 <- tidy(model5, conf.int = TRUE, exponentiate = TRUE) 
    results5

## 3. Calculate metrics

    # Check AIC for model comparison
    AIC(model5) 

## 4. Likelihood ratio tests

The likelihood ratio test is a test of the sufficiency of a smaller
model versus a more complex model. In this case all the variables added
were significant to assess the outcome.

    Anova(model5) 

## Forest plot

### Medium duration vs. short duration

    # Model results
    MOD <-results5 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == "3-6 months")
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values <- mapply(function(est, l, h) {

      paste0(est, " (", l, ", ", h, ")")

    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[22], NA, NA, values[23], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[24], NA, NA, values[25], NA, NA, values[26], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[22], NA, NA, confint$estimate[23], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[24], NA, NA, confint$estimate[25], NA, NA, confint$estimate[26], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[22], NA, NA, confint$conf.low[23], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA, confint$conf.low[24], NA, NA, confint$conf.low[25],NA, NA, confint$conf.low[26], NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[22], NA, NA, confint$conf.high[23], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[24], NA, NA, confint$conf.high[25], NA, NA, confint$conf.high[26], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6]
    )

    variables =  c("Variables", NA,
      "Alcohol use", "No", "Yes",
      "Non-opioid drug use", "No", "Yes",
      "Outpatient visit", "No", "Yes",
      "Psychiatric visit", "No", "Yes",
      "PTSD diagnosis", "No", "Yes",
      "Depression diagnosis", "No", "Yes",
      "Anxiety diagnosis", "No", "Yes",
      "Schizophrenia diagnosis", "No", "Yes",
      "Bipolar disorder diagnosis", "No", "Yes",
      "Sex", "Male", "Female",
      "Insurance type", "Commercial", "Medicaid", "Medicare", "Self-insured",
      "Age at episode",
      "Telehealth services", "No", "Yes",
      "Induction and maintenance treatment", "No", "Yes",
      "Buprenorphine treatment services", "No", "Yes",
      "Social Vulnerability Index", "High", "Low", "Low-Medium", "Medium-High",
      "Mental health services density",
        "Low mental health services density",
        "High mental health services density",
        "Moderate-High mental health services density",
        "Moderate-Low mental health services density",
      "Buprenorphine-waivered providers density",
        "Low-provider density",
        "High provider density",
        "Moderate-High provider density",
        "Moderate-Low provider density"
    )


    tabletext<-cbind(variables, estimates)    

    # total
    #png(file="../Figures/forest_medium_model5.png",width=2000,height=2200,res =200)
    pdf(file="../Figures/forest_medium_model5.pdf", height=12, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 10), T,F,F,F,F, F, rep(c(T,F,F),3), rep(c(T,F,F,F,F),3)),
                     vertices=TRUE, 
                     xticks=seq(0.75,2.25, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2.25, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(10, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_medium_model5.png")

### Extended Medium duration vs. short duration

    # Model results
    MOD <-results5 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == "6-12 months")
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values <- mapply(function(est, l, h) {

      paste0(est, " (", l, ", ", h, ")")

    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[22], NA, NA, values[23], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[24], NA, NA, values[25], NA, NA, values[26], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[22], NA, NA, confint$estimate[23], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[24], NA, NA, confint$estimate[25], NA, NA, confint$estimate[26], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[22], NA, NA, confint$conf.low[23], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA, confint$conf.low[24], NA, NA, confint$conf.low[25],NA, NA, confint$conf.low[26], NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[22], NA, NA, confint$conf.high[23], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[24], NA, NA, confint$conf.high[25], NA, NA, confint$conf.high[26], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6]
    )


    tabletext<-cbind(variables, estimates)    

    # total
    #png(file="../Figures/forest_exdMedium_model5.png",width=2000,height=2200,res =200)
    pdf(file="../Figures/forest_extMedium_model5.pdf", height=12, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 10), T,F,F,F,F, F, rep(c(T,F,F),3), rep(c(T,F,F,F,F),3)),
                     vertices=TRUE, 
                     xticks=seq(0.75,2, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.75,2, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(10, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_exdMedium_model5.png")

### Long duration vs. short duration

    # Model results
    MOD <-results5 %>% 
      filter(term != "(Intercept)") %>% 
      as.data.frame() %>%
      filter(y.level == ">12 months")
    #### create a table with CI in parenthese
    estimate = round(MOD[,3], digits = 2)
    low = round(MOD[,7], digits = 2)
    high = round(MOD[,8], digits = 2)
    values <- mapply(function(est, l, h) {

      paste0(est, " (", l, ", ", h, ")")

    }, estimate, low, high)
    #____________________________________________________
    #### Forest plots ###
    confint <- as.data.frame(MOD[,c(3,7,8)])

    estimates = c("Adjusted Odds Ratio (95% CI)", NA, NA, NA, values[15], NA, NA, values[16], NA, NA, values[22], NA, NA, values[23], NA, NA, values[17],
                  NA, NA, values[18], NA, NA, values[21], NA, NA, values[19], NA, NA, values[20], NA, NA, values[10], NA, NA, values[12:14], values[11], NA, NA, values[24], NA, NA, values[25], NA, NA, values[26], NA, NA, values[1:3], NA, NA, values[7:9], NA, NA, values[4:6]
                  )

    mean = c(NA, NA, NA,NA,
             confint$estimate[15], NA, NA, confint$estimate[16], NA, NA, confint$estimate[22], NA, NA, confint$estimate[23], NA, NA, confint$estimate[17],
             NA, NA, confint$estimate[18], NA, NA, confint$estimate[21], NA, NA, confint$estimate[19], NA, NA, confint$estimate[20], NA, NA, confint$estimate[10], NA, NA, confint$estimate[12:14],  confint$estimate[11], NA, NA, confint$estimate[24], NA, NA, confint$estimate[25], NA, NA, confint$estimate[26], NA, NA, confint$estimate[1:3], NA, NA, confint$estimate[7:9], NA, NA, confint$estimate[4:6]
    )
    lower = c(NA, NA, NA,NA,
             confint$conf.low[15], NA, NA, confint$conf.low[16], NA, NA, confint$conf.low[22], NA, NA, confint$conf.low[23], NA, NA, confint$conf.low[17],
             NA, NA, confint$conf.low[18], NA, NA, confint$conf.low[21], NA, NA, confint$conf.low[19], NA, NA, confint$conf.low[20], NA, NA, confint$conf.low[10], NA, NA, confint$conf.low[12:14],  confint$conf.low[11], NA, NA, confint$conf.low[24], NA, NA, confint$conf.low[25],NA, NA, confint$conf.low[26], NA, NA, confint$conf.low[1:3], NA, NA, confint$conf.low[7:9], NA, NA, confint$conf.low[4:6]
    )

    upper = c(NA, NA, NA,NA,
             confint$conf.high[15], NA, NA, confint$conf.high[16], NA, NA, confint$conf.high[22], NA, NA, confint$conf.high[23], NA, NA, confint$conf.high[17],
             NA, NA, confint$conf.high[18], NA, NA, confint$conf.high[21], NA, NA, confint$conf.high[19], NA, NA, confint$conf.high[20], NA, NA, confint$conf.high[10], NA, NA, confint$conf.high[12:14],  confint$conf.high[11], NA, NA, confint$conf.high[24], NA, NA, confint$conf.high[25], NA, NA, confint$conf.high[26], NA, NA, confint$conf.high[1:3], NA, NA, confint$conf.high[7:9], NA, NA, confint$conf.high[4:6]
    )


    tabletext<-cbind(variables, estimates)    

    # total
    #png(file="../Figures/forest_long_model5.png",width=2000,height=2200,res =200)
    pdf(file="../Figures/forest_long_model5.pdf", height=12, width=10)
    print(
      forestplot(tabletext, 
                     boxsize=0.15,
                     mean  = mean, 
                     lower = lower,
                     upper = upper,
                     zero = 1,
                     #clip=exp(c(0,22)),  
                     is.summary=c(T,F, rep(c(T,F,F), 10), T,F,F,F,F, F, rep(c(T,F,F),3), rep(c(T,F,F,F,F),3)),
                     vertices=TRUE, 
                     xticks=seq(0.5,2, by=0.25),
                     #xlog=T,
                     grid = structure(seq(0.5,2, by=0.25),
                                      gp = gpar(lty=3, col="#CCCCFF")),
                     col=fpColors(box="red",line="darkblue", summary="darkred"),
                     xlab="Odds Ratio (OR)",
                     txt_gp = fpTxtGp(summary=gpar(cex=0.75),
                                      label=gpar(cex=0.75),
                                      ticks=gpar(cex=0.75),
                                      xlab=gpar(cex=0.9)),
                     line.margin = unit(2, "cm"),
                     line.height = unit(2, "cm"),
                     graphwidth=unit(10,"cm")
                     )
    )

    dev.off()

    include_graphics("../Figures/forest_long_model5.png")

# Model 6 Remove sex (based on likelihood ratio tests)

## 1. Fit the model

    model6 <- multinom(treatment_duration_group ~ SVI_3digit_class + group_BP + group_MHAndSU + age + pay_type + alcohol + non_opioid_drugs + ptsd + depression + schizo + bipolar + anxiety + outpatient + psychiatric + telehealth + induction + bupre_tx, data = BTD_model_data1) 

    # save model results 
    saveRDS(model6, "../Results/BupDuration/MNR_model6_with_12mon_limit_v2.rds")

## 2. Interpret the coefficients

    model6 <- readRDS("../Results/BupDuration/MNR_model6_with_12mon_limit_v2.rds")
    results6 <- tidy(model6, conf.int = TRUE, exponentiate = TRUE) 
    results6

# Comparing 6 models

    # Check AIC for model comparison
    AIC(model1, model2, model3, model4, model5, model6) 
